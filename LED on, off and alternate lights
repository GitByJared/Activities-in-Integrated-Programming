#include <WiFi.h>
#include <WebServer.h>

const char* ssid = "Jared";
const char* password = "87654321";

// Define LED pins
const int ledPin1 = 19;  // LED 1
const int ledPin2 = 18;  // LED 2
const int ledPin3 = 5;  // LED 3
const int ledPin4 = 17;  // LED 4
const int ledPin5 = 16;  // LED 5

WebServer server(80);

// Variables for non-blocking alternate routine
bool alternateAllActive = false;  // flag to control alternating mode
unsigned long previousMillis = 0;
const unsigned long interval = 300;  // Interval (ms) for switching patterns
bool patternA = true;  // start with pattern A

void handleRoot() {
  // HTML content with buttons
  String html = "<!DOCTYPE html><html><head><title>ESP32 LED Control</title></head><body>";
  html += "<h1>ESP32 LED Control</h1>";
  html += "<button onclick=\"fetch('/off').then(response => alert('LED OFF!'))\">Turn LED OFF</button><br>";
  html += "<button onclick=\"fetch('/allon').then(response => alert('All LEDs ON!'))\">Turn ALL LEDs ON</button><br>";
  html += "<button onclick=\"fetch('/alternateall').then(response => alert('Alternating All LEDs!'))\">Alternate All LEDs</button><br>";
  html += "</body></html>";
  
  server.send(200, "text/html", html);
}

void handleOn() {
  // If you want to control a single LED:
  digitalWrite(ledPin1, HIGH);
  server.send(200, "text/plain", "LED is ON");
}

void handleOff() {
  // Turn off alternating routine (if running) and all LEDs.
  alternateAllActive = false;
  
  digitalWrite(ledPin1, LOW);
  digitalWrite(ledPin2, LOW);
  digitalWrite(ledPin3, LOW);
  digitalWrite(ledPin4, LOW);
  digitalWrite(ledPin5, LOW);
  
  server.send(200, "text/plain", "LEDs are OFF");
}

void handleAllOn() {
  // Turn off alternating routine (if running) and turn on all LEDs.
  alternateAllActive = false;
  
  digitalWrite(ledPin1, HIGH);
  digitalWrite(ledPin2, HIGH);
  digitalWrite(ledPin3, HIGH);
  digitalWrite(ledPin4, HIGH);
  digitalWrite(ledPin5, HIGH);
  
  server.send(200, "text/plain", "All LEDs are ON");
}

void handleAlternateAll() {
  // Start alternating mode. The routine in loop() will handle the switching.
  alternateAllActive = true;
  previousMillis = millis();  // reset timer
  patternA = true;             // start with Pattern A
  
  server.send(200, "text/plain", "Starting continuous alternating routine on all LEDs");
}

void setup() {
  Serial.begin(115200);
  
  pinMode(ledPin1, OUTPUT);
  pinMode(ledPin2, OUTPUT);
  pinMode(ledPin3, OUTPUT);
  pinMode(ledPin4, OUTPUT);
  pinMode(ledPin5, OUTPUT);

  // Initially, turn all LEDs off.
  digitalWrite(ledPin1, LOW);
  digitalWrite(ledPin2, LOW);
  digitalWrite(ledPin3, LOW);
  digitalWrite(ledPin4, LOW);
  digitalWrite(ledPin5, LOW);

  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
    Serial.println("Connecting to WiFi...");
  }
  Serial.println("Connected to WiFi");
  Serial.println(WiFi.localIP());

  server.on("/", handleRoot);
  server.on("/on", handleOn);
  server.on("/off", handleOff);
  server.on("/allon", handleAllOn);
  server.on("/alternateall", handleAlternateAll);

  server.begin();
  Serial.println("HTTP server started");
}

void loop() {
  server.handleClient();
  
  // Handle non-blocking alternating routine
  if (alternateAllActive) {
    unsigned long currentMillis = millis();
    if (currentMillis - previousMillis >= interval) {
      previousMillis = currentMillis;
      
      if (patternA) {
        // Pattern A: LEDs 1,3,5 ON; LEDs 2,4 OFF.
        digitalWrite(ledPin1, HIGH);
        digitalWrite(ledPin2, LOW);
        digitalWrite(ledPin3, HIGH);
        digitalWrite(ledPin4, LOW);
        digitalWrite(ledPin5, HIGH);
      } else {
        // Pattern B: LEDs 2,4 ON; LEDs 1,3,5 OFF.
        digitalWrite(ledPin1, LOW);
        digitalWrite(ledPin2, HIGH);
        digitalWrite(ledPin3, LOW);
        digitalWrite(ledPin4, HIGH);
        digitalWrite(ledPin5, LOW);
      }
      
      // Toggle the pattern for next interval
      patternA = !patternA;
    }
  }
}
